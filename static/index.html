<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #1e1e1e;
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-family: 'Consolas', monospace;
            overflow: hidden;
        }
        .header {
            background-color: #2d2d2d;
            color: #fff;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .header h1 {
            margin: 0;
            font-size: 1.2em;
            color: #00ff00;
        }
        .terminal-container {
            flex: 1;
            background-color: #000;
            padding: 5px;
            overflow: hidden;
        }
        .xterm {
            height: 100%;
            padding: 5px;
        }
        .status {
            color: #666;
            font-size: 0.9em;
        }
        .connection-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .connection-status.connected {
            background-color: #00ff00;
        }
        .connection-status.disconnected {
            background-color: #ff0000;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Web Terminal</h1>
        <div class="status">
            <span class="connection-status disconnected"></span>
            <span class="status-text">Disconnected</span>
        </div>
    </div>
    <div class="terminal-container" id="terminal-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.1.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.7.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-search@0.13.0/lib/xterm-addon-search.js"></script>
    <script>
        const term = new Terminal({
            cursorBlink: true,
            cursorStyle: 'block',
            macOptionIsMeta: true,
            scrollback: 10000,
            fontSize: 14,
            fontFamily: 'Consolas, monospace',
            cols: 120,
            rows: 30,
            theme: {
                background: '#000000',
                foreground: '#ffffff',
                cursor: '#00ff00',
                selection: 'rgba(255, 255, 255, 0.3)',
                black: '#000000',
                red: '#e06c75',
                green: '#98c379',
                yellow: '#d19a66',
                blue: '#61afef',
                magenta: '#c678dd',
                cyan: '#56b6c2',
                white: '#abb2bf',
                brightBlack: '#5c6370',
                brightRed: '#e06c75',
                brightGreen: '#98c379',
                brightYellow: '#d19a66',
                brightBlue: '#61afef',
                brightMagenta: '#c678dd',
                brightCyan: '#56b6c2',
                brightWhite: '#ffffff'
            },
            allowProposedApi: true,
            convertEol: true,
            windowsMode: true,
            allowTransparency: true
        });

        // Load addons
        const fitAddon = new FitAddon.FitAddon();
        const webLinksAddon = new WebLinksAddon.WebLinksAddon();
        const searchAddon = new SearchAddon.SearchAddon();
        
        term.loadAddon(fitAddon);
        term.loadAddon(webLinksAddon);
        term.loadAddon(searchAddon);
        
        term.open(document.getElementById('terminal-container'));
        fitAddon.fit();

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${window.location.host}/ws/${Math.random().toString(36).substring(7)}`);

        const statusIndicator = document.querySelector('.connection-status');
        const statusText = document.querySelector('.status-text');

        ws.onopen = () => {
            statusIndicator.classList.remove('disconnected');
            statusIndicator.classList.add('connected');
            statusText.textContent = 'Connected';
            
            // Send initial terminal size
            const dimensions = {
                cols: term.cols,
                rows: term.rows
            };
            ws.send(JSON.stringify(dimensions));
        };

        ws.onclose = () => {
            statusIndicator.classList.remove('connected');
            statusIndicator.classList.add('disconnected');
            statusText.textContent = 'Disconnected';
            term.write('\r\n\x1b[1;31mConnection closed. Refresh to reconnect.\x1b[0m\r\n');
        };

        ws.onmessage = (event) => {
            term.write(event.data);
        };

        // Track cursor position and input buffer
        let cursorX = 0;
        let inputBuffer = '';

        term.onData(data => {
            if (ws.readyState === WebSocket.OPEN) {
                if (data === '\x7F' || data === '\b') { // Backspace or Delete
                    if (cursorX > 0) {
                        // Update local buffer
                        inputBuffer = inputBuffer.slice(0, -1);
                        cursorX--;
                        // Send backspace to server
                        ws.send('\b');
                    }
                } else if (data === '\r') { // Enter
                    ws.send(data);
                    inputBuffer = '';
                    cursorX = 0;
                } else {
                    // Update local buffer
                    inputBuffer += data;
                    cursorX += data.length;
                    ws.send(data);
                }
            }
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            fitAddon.fit();
            const dimensions = {
                type: 'resize',
                cols: term.cols,
                rows: term.rows
            };
            ws.send(JSON.stringify(dimensions));
        });

        // Reset cursor position on Enter
        term.onKey(e => {
            const ev = e.domEvent;
            if (ev.keyCode === 13) { // Enter
                cursorX = 0;
                inputBuffer = '';
            }
        });

        // Focus terminal on click
        document.getElementById('terminal-container').addEventListener('click', () => {
            term.focus();
        });

        // Initial focus
        term.focus();
    </script>
</body>
</html>
